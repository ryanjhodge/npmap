!function(){L.Handler.MarkerSnap=L.Handler.extend({options:{snapDistance:15,snapVertices:!0},initialize:function(a,b,c){function d(){this._buffer=a.layerPointToLatLng(new L.Point(0,0)).lat-a.layerPointToLatLng(new L.Point(this.options.snapDistance,0)).lat}L.Handler.prototype.initialize.call(this,a),this._markers=[],this._guides=[],2==arguments.length&&(b instanceof L.Class||(c=b,b=null)),L.Util.setOptions(this,c||{}),b&&(b.dragging||(b.dragging=new L.Handler.MarkerDrag(b)),b.dragging.enable(),this.watchMarker(b)),a.on("zoomend",d,this),a.whenReady(d,this),d.call(this)},enable:function(){this.disable();for(var a=0;a<this._markers.length;a++)this.watchMarker(this._markers[a])},disable:function(){for(var a=0;a<this._markers.length;a++)this.unwatchMarker(this._markers[a])},watchMarker:function(a){this._markers.indexOf(a)==-1&&this._markers.push(a),a.on("move",this._snapMarker,this)},unwatchMarker:function(a){a.off("move",this._snapMarker,this),delete a.snap},addGuideLayer:function(a){for(var b=0,c=this._guides.length;b<c;b++)if(L.stamp(a)===L.stamp(this._guides[b]))return;this._guides.push(a)},_snapMarker:function(a){function b(a){if(a.getLatLng)return L.stamp(d)!==L.stamp(a);if(a.editing&&a.editing._enabled)for(var b=a.editing._verticesHandlers[0]._markerGroup.getLayers(),c=0,e=b.length;c<e;c++)if(L.stamp(b[c])===L.stamp(d))return!1;return!0}function c(a){if(void 0!==a._layers&&"function"!=typeof a.searchBuffer)for(var d in a._layers)c(a._layers[d]);else if("function"==typeof a.searchBuffer){var g=a.searchBuffer(e,this._buffer);f=f.concat(g.filter(function(a){return b(a)}))}else b(a)&&f.push(a)}for(var d=a.target,e=d.getLatLng(),f=[],g=0,h=this._guides.length;g<h;g++){var i=this._guides[g];c.call(this,i)}var j=this._findClosestLayerSnap(this._map,f,e,this.options.snapDistance,this.options.snapVertices);j=j||{layer:null,latlng:null},this._updateSnap(d,j.layer,j.latlng)},_findClosestLayerSnap:function(a,b,c,d,e){return L.GeometryUtil.closestLayerSnap(a,b,c,d,e)},_updateSnap:function(a,b,c){b&&c?(a._latlng=L.latLng(c),a.update(),a.snap!=b&&(a.snap=b,a._icon&&L.DomUtil.addClass(a._icon,"marker-snapped"),a.fire("snap",{layer:b,latlng:c}))):(a.snap&&(a._icon&&L.DomUtil.removeClass(a._icon,"marker-snapped"),a.fire("unsnap",{layer:a.snap})),delete a.snap)}}),L.Edit&&(L.Handler.PolylineSnap=L.Edit.Poly.extend({initialize:function(a,b,c){var d=this;L.Edit.Poly.prototype.initialize.call(this,b,c),this._snapper=new L.Handler.MarkerSnap(a,c),b.on("remove",function(){d.disable()})},addGuideLayer:function(a){this._snapper.addGuideLayer(a)},_initHandlers:function(){this._verticesHandlers=[];for(var a=0;a<this.latlngs.length;a++)this._verticesHandlers.push(new L.Edit.PolyVerticesEditSnap(this._poly,this.latlngs[a],this.options))}}),L.Edit.PolyVerticesEditSnap=L.Edit.PolyVerticesEdit.extend({_createMarker:function(a,b){var c=L.Edit.PolyVerticesEdit.prototype._createMarker.call(this,a,b),d=void 0===b;return d?c.on("dragstart",function(){this._poly.snapediting._snapper.watchMarker(c)},this):this._poly.snapediting._snapper.watchMarker(c),c}}),L.EditToolbar.SnapEdit=L.EditToolbar.Edit.extend({snapOptions:{snapDistance:15,snapVertices:!0},initialize:function(a,b){L.EditToolbar.Edit.prototype.initialize.call(this,a,b),b.snapOptions&&L.Util.extend(this.snapOptions,b.snapOptions),Array.isArray(this.snapOptions.guideLayers)?this._guideLayers=this.snapOptions.guideLayers:b.guideLayers instanceof L.LayerGroup?this._guideLayers=this.snapOptions.guideLayers.getLayers():this._guideLayers=[]},addGuideLayer:function(a){var b=this._guideLayers.findIndex(function(b){return L.stamp(a)===L.stamp(b)});b===-1&&(this._guideLayers.push(a),this._featureGroup.eachLayer(function(a){a.snapediting&&a.snapediting._guides.push(a)}))},removeGuideLayer:function(a){var b=this._guideLayers.findIndex(function(b){return L.stamp(a)===L.stamp(b)});b!==-1&&(this._guideLayers.splice(b,1),this._featureGroup.eachLayer(function(a){a.snapediting&&a.snapediting._guides.splice(b,1)}))},clearGuideLayers:function(){this._guideLayers=[],this._featureGroup.eachLayer(function(a){a.snapediting&&(a.snapediting._guides=[])})},_enableLayerEdit:function(a){L.EditToolbar.Edit.prototype._enableLayerEdit.call(this,a);var b=a.layer||a.target||a;if(!b.snapediting){b.getLatLng?b.snapediting=new L.Handler.MarkerSnap(b._map,b,this.snapOptions):(b.editing&&(b.editing._verticesHandlers[0]._markerGroup.clearLayers(),delete b.editing),b.editing=b.snapediting=new L.Handler.PolylineSnap(b._map,b,this.snapOptions));for(var c=0,d=this._guideLayers.length;c<d;c++)b.snapediting.addGuideLayer(this._guideLayers[c])}b.snapediting.enable()}}),L.Draw.Feature.SnapMixin={_snap_initialize:function(){this.on("enabled",this._snap_on_enabled,this),this.on("disabled",this._snap_on_disabled,this)},_snap_on_enabled:function(){if(this.options.guideLayers){if(!this._mouseMarker)return void this._map.on("layeradd",this._snap_on_enabled,this);this._map.off("layeradd",this._snap_on_enabled,this),this._snapper||(this._snapper=new L.Handler.MarkerSnap(this._map),this.options.snapDistance&&(this._snapper.options.snapDistance=this.options.snapDistance),this.options.snapVertices&&(this._snapper.options.snapVertices=this.options.snapVertices));for(var a=0,b=this.options.guideLayers.length;a<b;a++)this._snapper.addGuideLayer(this.options.guideLayers[a]);var c=this._mouseMarker;this._snapper.watchMarker(c);var d=c.options.icon;c.on("snap",function(a){c.setIcon(this.options.icon),c.setOpacity(1)},this).on("unsnap",function(a){c.setIcon(d),c.setOpacity(0)},this),c.on("click",this._snap_on_click,this)}},_snap_on_click:function(a){if(this._markers){var b=this._markers.length,c=this._markers[b-1];if(this._mouseMarker.snap){if(a&&(c.setLatLng(a.target._latlng),this._poly)){var d=this._poly._latlngs.length;this._poly._latlngs[d-1]=a.target._latlng,this._poly.redraw()}L.DomUtil.addClass(c._icon,"marker-snapped")}}},_snap_on_disabled:function(){delete this._snapper}},L.Draw.Feature.include(L.Draw.Feature.SnapMixin),L.Draw.Feature.addInitHook("_snap_initialize"))}();